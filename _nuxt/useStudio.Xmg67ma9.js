import{d as X,u as H,r as L,o as Y,_ as j,a as ee,c as R,b as q,e as K,f as F,n as te,F as ne,g as y,w as O,T as J,t as ie,h as D,i as V,j as oe,k as se,l as B,m as E,p as M,q as ae,s as U,v as re,x as W}from"./entry.BEDwTZ_8.js";import{q as de,u as le}from"./query.DyBQkc6j.js";import"./preview.CAzgo671.js";const ue={key:0},ce={key:0},pe={id:"__preview_loader"},fe=X({__name:"ContentPreviewMode",props:{previewToken:{type:String,required:!0},apiURL:{type:String,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(o){const s=o,a=["__nuxt_preview","__preview_enabled"],p=V(),h=H(),l=L(!0),k=L(!1),i=L(!1),c=L("");let r;const m=async()=>{D("previewToken").value="",window.sessionStorage.removeItem("previewToken"),await h.replace({query:{preview:void 0}}),window.location.reload()},b=async x=>{const d=await s.syncPreview(x);if(i.value!==!0){if(!d){setTimeout(()=>b(x),1e3);return}D("previewToken").value&&(i.value=!0,await h.replace({query:{}}),p.callHook("nuxt-studio:preview:ready"),window.parent&&window.self!==window.parent&&r.disconnect())}};return Y(async()=>{r=(await j(()=>import("./index.RqoUCiIh.js"),__vite__mapDeps([]),import.meta.url)).connect(`${s.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:s.previewToken}});let d;r.on("connect",()=>{d=setTimeout(()=>{i.value||(d=setTimeout(()=>{c.value="Preview sync timed out",i.value=!1},3e4),r.emit("draft:requestSync"))},3e4)});const P=()=>{d&&(clearTimeout(d),d=null)};r.on("draft:sync",async I=>{if(P(),!I){try{r.once("draft:ready",()=>{r.emit("draft:requestSync")}),await s.requestPreviewSyncAPI()}catch(S){switch(P(),S.response.status){case 404:c.value="Preview draft not found",i.value=!1;break;default:c.value="An error occurred while syncing preview",i.value=!1}}return}b(I)}),r.on("draft:unauthorized",()=>{P(),c.value="Unauthorized preview token",i.value=!1}),r.on("disconnect",()=>{P()}),document.body.classList.add(...a),r.on("draft:update",I=>{k.value=!0,s.syncPreview(I),k.value=!1})}),ee(()=>{document.body.classList.remove(...a)}),(x,d)=>(q(),R("div",null,[l.value?(q(),R("div",{key:0,id:"__nuxt_preview",class:te({__preview_ready:i.value,__preview_refreshing:k.value})},[i.value?(q(),R(ne,{key:0},[d[0]||(d[0]=y("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[y("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),d[1]||(d[1]=y("span",null,"Preview mode enabled",-1)),y("button",{onClick:m}," Close ")],64)):K("",!0)],2)):K("",!0),F(J,{name:"preview-loading"},{default:O(()=>[l.value&&!i.value&&!c.value?(q(),R("div",ue,[d[4]||(d[4]=y("div",{id:"__preview_background"},null,-1)),y("div",{id:"__preview_loader"},[d[2]||(d[2]=y("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[y("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),d[3]||(d[3]=y("p",null,"Initializing the preview...",-1)),y("button",{onClick:m}," Cancel ")])])):K("",!0)]),_:1}),F(J,{name:"preview-loading"},{default:O(()=>[c.value?(q(),R("div",ce,[d[5]||(d[5]=y("div",{id:"__preview_background"},null,-1)),y("div",pe,[y("p",null,ie(c.value),1),y("button",{onClick:m}," Exit preview ")])])):K("",!0)]),_:1})]))}}),ve=oe(fe,[["__scopeId","data-v-2b9f80bf"]]),we=(o=[],s,a)=>{const p=[...s||[]],h=[...a||[]],l=JSON.parse(JSON.stringify(o));for(const i of p)if(i.oldPath)if(h.splice(h.findIndex(r=>r.path===i.oldPath),1),p.find(r=>r.path===i.oldPath))l.push({path:i.path,parsed:i.parsed});else{const r=l.find(m=>m.path===i.oldPath);r&&(r.path=i.path,i.parsed?r.parsed=i.parsed:i.pathMeta&&["_file","_path","_id","_locale"].forEach(m=>{r.parsed[m]=i.pathMeta[m]}))}else if(i.new)l.push({path:i.path,parsed:i.parsed});else{const c=l.find(r=>r.path===i.path);c&&Object.assign(c,{path:i.path,parsed:i.parsed})}for(const i of h)l.splice(l.findIndex(c=>c.path===i.path),1);const k=new Intl.Collator(void 0,{numeric:!0});return l.sort((i,c)=>k.compare(i.path,c.path)),l},_={appConfig:"app.config.ts",nuxtConfig:"nuxt.config.ts",tokensConfig:"tokens.config.ts"},ye=o=>{let s;return(...a)=>(s||(s=o()),s)};function Z(o,s){for(const a in o){const p=s[a];a in s||delete o[a],p!==null&&typeof p=="object"&&Z(o[a],s[a])}}function G(o,s){for(const a in s){const p=s[a];p!==null&&typeof p=="object"?Array.isArray(p)&&Array.isArray(o[a])?o[a]=p:(o[a]=o[a]||{},G(o[a],p)):o[a]=p}}const me=ye(()=>JSON.parse(JSON.stringify(W()))),z=re((o,s,a)=>{if(Array.isArray(o[s])&&Array.isArray(a))return o[s]=a,!0}),Pe=()=>{const o=V(),{studio:s,content:a}=se().public,p=me();let h;const l=B("studio-client-db",()=>null),k=B("studio-preview-db-files",()=>[]);l.value||(o.hook("content:storage",e=>{l.value=e}),de("/non-existing-path").findOne());const i=async(e,t,u=!0)=>{const v=window.sessionStorage.getItem("previewToken"),w=await e.getKeys(`${v}:`);await Promise.all(w.map(f=>e.removeItem(f)));const n=new Set(t.map(f=>f.parsed._id.split(":").shift()));await e.setItem(`${v}$`,JSON.stringify({ignoreSources:Array.from(n)})),await Promise.all(t.map(f=>e.setItem(`${v}:${f.parsed._id}`,JSON.stringify(f.parsed))))},c=e=>{const t=U(o,W);t!=null&&t.ui&&(t.ui.icons={...t.ui.icons,dynamic:!0}),G(t,z(e,p)),e||Z(t,p)},r=e=>{var u,v,w,n;const t=(n=(w=(v=(u=o==null?void 0:o.vueApp)==null?void 0:u._context)==null?void 0:v.config)==null?void 0:w.globalProperties)==null?void 0:n.$pinceauTheme;!t||!(t!=null&&t.updateTheme)||(h||(h=JSON.parse(JSON.stringify((t==null?void 0:t.theme.value)||{}))),U(o,t.updateTheme,[z(e,h)]))},m=async e=>{if(k.value=e.files=e.files||k.value||[],!l.value)return!1;const t=we(e.files,e.additions,e.deletions),u=t.filter(n=>![_.appConfig,_.nuxtConfig,_.tokensConfig].includes(n.path));await i(l.value,u,(e.files||[]).length!==0);const v=t.find(n=>n.path===_.appConfig);c(v==null?void 0:v.parsed);const w=t.find(n=>n.path===_.tokensConfig);return r(w==null?void 0:w.parsed),S(),!0},b=async()=>{const e=window.sessionStorage.getItem("previewToken");await $fetch("api/projects/preview/sync",{baseURL:s==null?void 0:s.apiURL,method:"POST",params:{token:e}})},x=()=>{const e=window.sessionStorage.getItem("previewToken"),t=document.createElement("div");t.id="__nuxt_preview_wrapper",document.body.appendChild(t),ae(ve,{previewToken:e,apiURL:s==null?void 0:s.apiURL,syncPreview:m,requestPreviewSyncAPI:b}).mount(t)},d=async e=>{var v,w,n;const t=window.sessionStorage.getItem("previewToken");if(!e)return null;e=e.replace(/\/$/,"");let u=await((v=l.value)==null?void 0:v.getItem(`${t}:${e}`));return u||(u=await((w=l.value)==null?void 0:w.getItem(`cached:${e}`))),u||(u=u=await((n=l.value)==null?void 0:n.getItem(e))),u},P=e=>{var u;const t=window.sessionStorage.getItem("previewToken");l.value&&l.value.setItem(`${t}:${(u=e.parsed)==null?void 0:u._id}`,JSON.stringify(e.parsed))},I=async e=>{var u;const t=window.sessionStorage.getItem("previewToken");await((u=l.value)==null?void 0:u.removeItem(`${t}:${e}`))},S=async()=>{if(a!=null&&a.documentDriven){const{pages:e}=U(o,le);for(const t in e.value)e.value[t]&&(e.value[t]=await d(e.value[t]._id))}await o.hooks.callHookParallel("app:data:refresh")};return{apiURL:s==null?void 0:s.apiURL,contentStorage:l,syncPreviewFiles:i,syncPreviewAppConfig:c,syncPreviewTokensConfig:r,requestPreviewSynchronization:b,findContentWithId:d,updateContent:P,removeContentWithId:I,requestRerender:S,mountPreviewUI:x,initiateIframeCommunication:Q};function Q(){if(!window.parent||window.self===window.parent)return;const e=H(),t=E(),u=L(""),v=n=>({path:n.path,query:M(n.query),params:M(n.params),fullPath:n.fullPath,meta:M(n.meta)});window.addEventListener("keydown",n=>{(n.metaKey||n.ctrlKey||n.altKey||n.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:n.key,metaKey:n.metaKey,ctrlKey:n.ctrlKey,shiftKey:n.shiftKey,altKey:n.altKey}},"*")}),window.addEventListener("message",async n=>{if(!["https://nuxt.studio","https://dev.nuxt.studio","http://localhost:3000"].includes(n.origin))return;const{type:f,payload:A={}}=n.data||{};switch(f){case"nuxt-studio:editor:file-selected":{const g=await d(A.path);g&&(g._partial||g._path!==E().path&&(u.value=g._path,e.push(g._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:g=[],deletions:$=[]}=A;for(const C of g)await P(C);for(const C of $)await I(C.path);S();break}case"nuxt-studio:preview:sync":{m(A);break}case"nuxt-studio:config:file-changed":{const{additions:g=[],deletions:$=[]}=A,C=g.find(T=>T.path===_.appConfig);C&&c(C==null?void 0:C.parsed),$.find(T=>T.path===_.appConfig)&&c(void 0);const N=g.find(T=>T.path===_.tokensConfig);N&&r(N==null?void 0:N.parsed),$.find(T=>T.path===_.tokensConfig)&&r(void 0);break}}}),o.hook("page:finish",()=>{w(),o.payload.prerenderedAt&&S()}),o.hook("content:document-driven:finish",({route:n,page:f})=>{n.meta.studio_page_contentId=f==null?void 0:f._id}),o.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:v(E())},"*"),setTimeout(()=>{w()},100)});function w(){const n=Array.from(window.document.querySelectorAll("[data-content-id]")).map(A=>A.getAttribute("data-content-id")),f=Array.from(new Set([t.meta.studio_page_contentId,...n])).filter(Boolean);if(u.value===f[0]){u.value="";return}window.openContentInStudioEditor(f,{navigate:!0,pageContentId:t.meta.studio_page_contentId})}window.openContentInStudioEditor=(n,f={})=>{window.parent.postMessage({type:"nuxt-studio:preview:navigate",payload:{...v(t),contentIds:n,...f}},"*")}}};export{Pe as useStudio};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
